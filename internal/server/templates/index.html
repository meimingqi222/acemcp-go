<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acemcp-Go Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100">
    <div x-data="mcpManager()" x-init="init()" class="container mx-auto p-6">
        <header class="bg-white shadow rounded-lg p-6 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800" x-text="t('title')"></h1>
                <p class="text-gray-600 mt-2" x-text="t('subtitle')"></p>
            </div>
            <div class="flex gap-2">
                <button @click="setLanguage('en')" :class="lang === 'en' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1 rounded text-sm">
                    English
                </button>
                <button @click="setLanguage('zh')" :class="lang === 'zh' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1 rounded text-sm">
                    中文
                </button>
            </div>
        </header>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2" x-text="t('status')"></h3>
                <p class="text-2xl font-bold" :class="status.status === 'ready' ? 'text-green-600' : status.status === 'starting' ? 'text-yellow-600' : 'text-red-600'" x-text="t('status_' + status.status)"></p>
            </div>
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2" x-text="t('indexed_projects')"></h3>
                <p class="text-2xl font-bold text-blue-600" x-text="Object.keys(projects).length"></p>
            </div>
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2" x-text="t('total_blobs')"></h3>
                <p class="text-2xl font-bold text-purple-600" x-text="totalBlobs"></p>
            </div>
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2" x-text="t('watching')"></h3>
                <p class="text-2xl font-bold text-orange-600" x-text="metrics.watch_projects || 0"></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Configuration -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800" x-text="t('configuration')"></h2>
                    <button @click="refreshData()" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                        ↻ <span x-text="t('refresh')"></span>
                    </button>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('listen_addr')"></span>
                        <span class="text-gray-600" x-text="config.listen"></span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('http_addr')"></span>
                        <span class="text-gray-600" x-text="config.http"></span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('data_dir')"></span>
                        <span class="text-gray-600 truncate max-w-xs" x-text="config.data"></span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('base_url')"></span>
                        <span class="text-gray-600 truncate max-w-xs" x-text="config.base"></span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('batch_size')"></span>
                        <span class="text-gray-600" x-text="config.batch"></span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('max_lines')"></span>
                        <span class="text-gray-600" x-text="config.maxln"></span>
                    </div>
                    <div class="flex justify-between border-b pb-2 items-center">
                        <span class="font-medium text-gray-700" x-text="t('token_check')"></span>
                        <div class="flex items-center gap-2">
                            <button @click="checkToken()" class="px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" :disabled="tokenCheckLoading" x-text="tokenCheckLoading ? '...' : t('token_check_btn')"></button>
                            <template x-if="tokenCheck">
                                <span class="text-xs" :class="tokenCheck?.remote?.ok ? 'text-green-600' : 'text-red-600'" x-text="tokenCheck?.remote?.ok ? t('token_ok') : t('token_fail')"></span>
                            </template>
                        </div>
                    </div>
                    <div x-show="tokenCheck" class="space-y-1">
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-500" x-text="t('token_remote')"></span>
                            <span class="text-gray-600" x-text="(tokenCheck?.remote?.status_code ? ('HTTP ' + tokenCheck.remote.status_code) : '') + (tokenCheck?.remote?.request_id ? (' / ' + tokenCheck.remote.request_id) : '')"></span>
                        </div>
                        <div class="text-xs text-red-600" x-show="tokenCheck?.remote && !tokenCheck.remote.ok && tokenCheck.remote.error" x-text="tokenCheck.remote.error"></div>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700" x-text="t('version')"></span>
                        <span class="text-gray-600" x-text="config.ver"></span>
                    </div>
                </div>
            </div>

            <!-- Metrics -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4" x-text="t('metrics')"></h2>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('index_runs')"></span>
                        <span class="text-gray-600" x-text="metrics.index_runs || 0"></span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('search_runs')"></span>
                        <span class="text-gray-600" x-text="metrics.search_runs || 0"></span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium text-gray-700" x-text="t('last_index')"></span>
                        <span class="text-gray-600" x-text="formatTime(metrics.last_index_time)"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700" x-text="t('last_search')"></span>
                        <span class="text-gray-600" x-text="formatTime(metrics.last_search_time)"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects List -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4" x-text="t('projects')"></h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="t('project_path')"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="t('blob_count')"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="t('failed_count')"></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="[path, count] in Object.entries(projects)" :key="path">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="path"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="count"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm" :class="(failed[path]?.length || 0) > 0 ? 'text-red-600' : 'text-green-600'" x-text="failed[path]?.length || 0"></td>
                            </tr>
                        </template>
                        <template x-if="Object.keys(projects).length === 0">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-center text-gray-500" x-text="t('no_projects')"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Failed Blobs -->
        <div x-show="Object.keys(failed).length > 0" class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-red-600 mb-4" x-text="t('failed_blobs')"></h2>
            <div class="space-y-4">
                <template x-for="[project, blobs] in Object.entries(failed)" :key="project">
                    <div x-show="blobs.length > 0" class="border rounded p-4">
                        <h3 class="font-semibold text-gray-800 mb-2" x-text="project"></h3>
                        <div class="space-y-2">
                            <template x-for="blob in blobs.slice(0, 5)" :key="blob.blob_hash">
                                <div class="text-sm bg-red-50 p-2 rounded">
                                    <span class="font-mono text-gray-700" x-text="blob.path"></span>
                                    <span class="text-red-600 ml-2" x-text="blob.error"></span>
                                </div>
                            </template>
                            <div x-show="blobs.length > 5" class="text-sm text-gray-500" x-text="'... and ' + (blobs.length - 5) + ' more'"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Operation Logs -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800" x-text="t('operation_logs')"></h2>
                <button @click="clearLogs()" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm" x-text="t('clear')"></button>
            </div>
            <div class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs h-64 overflow-y-auto" id="log-container">
                <template x-for="log in logs" :key="log.id">
                    <div class="mb-1 flex flex-wrap">
                        <span class="text-gray-500 mr-2" x-text="formatLogTime(log.time)"></span>
                        <span class="mr-2" :class="log.type === 'index' ? 'text-blue-400' : log.type === 'search' ? 'text-yellow-400' : 'text-purple-400'" x-text="'[' + log.type.toUpperCase() + ']'"></span>
                        <span class="mr-2" :class="log.level === 'error' ? 'text-red-400' : log.level === 'warn' ? 'text-yellow-300' : log.level === 'debug' ? 'text-gray-400' : 'text-green-400'" x-text="log.message"></span>
                        <template x-if="log.duration_ms > 0">
                            <span class="text-cyan-400" x-text="log.duration_ms + 'ms'"></span>
                        </template>
                        <template x-if="log.type === 'search' && (log.index_ms > 0 || log.api_ms > 0)">
                            <span class="text-gray-400 ml-2" x-text="'(index: ' + log.index_ms + 'ms, api: ' + log.api_ms + 'ms)'"></span>
                        </template>
                    </div>
                </template>
                <template x-if="logs.length === 0">
                    <div class="text-gray-500" x-text="t('no_logs')"></div>
                </template>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                title: 'Acemcp-Go Management',
                subtitle: 'Go Implementation of Code Indexing MCP Server',
                status: 'Status',
                status_ready: 'Ready',
                status_starting: 'Starting',
                status_stopping: 'Stopping',
                indexed_projects: 'Indexed Projects',
                total_blobs: 'Total Blobs',
                watching: 'Watching',
                configuration: 'Configuration',
                refresh: 'Refresh',
                listen_addr: 'RPC Listen',
                http_addr: 'HTTP Address',
                data_dir: 'Data Directory',
                base_url: 'Base URL',
                batch_size: 'Batch Size',
                max_lines: 'Max Lines/Blob',
                token_check: 'Token Check',
                token_check_btn: 'Check',
                token_remote: 'Remote',
                token_ok: 'OK',
                token_fail: 'Fail',
                version: 'Version',
                metrics: 'Metrics',
                index_runs: 'Index Runs',
                search_runs: 'Search Runs',
                last_index: 'Last Index',
                last_search: 'Last Search',
                projects: 'Indexed Projects',
                project_path: 'Project Path',
                blob_count: 'Blob Count',
                failed_count: 'Failed',
                no_projects: 'No projects indexed yet',
                failed_blobs: 'Failed Blobs',
                never: 'Never',
                operation_logs: 'Operation Logs',
                clear: 'Clear',
                no_logs: 'No operation logs yet'
            },
            zh: {
                title: 'Acemcp-Go 管理',
                subtitle: 'Go 语言实现的代码索引 MCP 服务器',
                status: '状态',
                status_ready: '就绪',
                status_starting: '启动中',
                status_stopping: '停止中',
                indexed_projects: '已索引项目',
                total_blobs: '总代码块',
                watching: '监视中',
                configuration: '配置',
                refresh: '刷新',
                listen_addr: 'RPC 监听',
                http_addr: 'HTTP 地址',
                data_dir: '数据目录',
                base_url: '基础 URL',
                batch_size: '批量大小',
                max_lines: '最大行数/块',
                token_check: 'Token 验证',
                token_check_btn: '验证',
                token_remote: '远端',
                token_ok: '可用',
                token_fail: '失败',
                version: '版本',
                metrics: '指标',
                index_runs: '索引次数',
                search_runs: '搜索次数',
                last_index: '最后索引',
                last_search: '最后搜索',
                projects: '已索引项目',
                project_path: '项目路径',
                blob_count: '代码块数',
                failed_count: '失败数',
                no_projects: '暂无已索引项目',
                failed_blobs: '失败的代码块',
                never: '从未',
                operation_logs: '操作日志',
                clear: '清空',
                no_logs: '暂无操作日志'
            }
        };

        function mcpManager() {
            return {
                lang: localStorage.getItem('lang') || 'zh',
                status: { status: 'starting' },
                config: {},
                projects: {},
                failed: {},
                metrics: {},
                logs: [],
                lastLogId: 0,
                totalBlobs: 0,
                refreshInterval: null,

                t(key) {
                    return translations[this.lang][key] || key;
                },

                setLanguage(lang) {
                    this.lang = lang;
                    localStorage.setItem('lang', lang);
                },

                async init() {
                    await this.refreshData();
                    await this.loadLogs();
                    this.refreshInterval = setInterval(() => this.refreshData(), 10000);
                    setInterval(() => this.pollLogs(), 3000);
                },

                async refreshData() {
                    await Promise.all([
                        this.loadStatus(),
                        this.loadProjects(),
                        this.loadFailed(),
                        this.loadMetrics()
                    ]);
                },

                async loadStatus() {
                    try {
                        const response = await fetch('/status');
                        const data = await response.json();
                        this.status = { status: data.status };
                        this.config = data.data || {};
                    } catch (e) {
                        console.error('Failed to load status:', e);
                    }
                },

                tokenCheck: null,
                tokenCheckLoading: false,

                async checkToken() {
                    this.tokenCheckLoading = true;
                    try {
                        const response = await fetch('/token-check');
                        this.tokenCheck = await response.json();
                    } catch (e) {
                        this.tokenCheck = { remote: { ok: false, error: String(e) } };
                    } finally {
                        this.tokenCheckLoading = false;
                    }
                },

                async loadProjects() {
                    try {
                        const response = await fetch('/projects');
                        this.projects = await response.json();
                        this.totalBlobs = Object.values(this.projects).reduce((a, b) => a + b, 0);
                    } catch (e) {
                        console.error('Failed to load projects:', e);
                    }
                },

                async loadFailed() {
                    try {
                        const response = await fetch('/failed');
                        this.failed = await response.json();
                    } catch (e) {
                        console.error('Failed to load failed:', e);
                    }
                },

                async loadMetrics() {
                    try {
                        const response = await fetch('/metrics');
                        this.metrics = await response.json();
                    } catch (e) {
                        console.error('Failed to load metrics:', e);
                    }
                },

                async loadLogs() {
                    try {
                        const response = await fetch('/logs');
                        this.logs = await response.json();
                        if (this.logs.length > 0) {
                            this.lastLogId = this.logs[0].id;
                        }
                        this.scrollLogsToBottom();
                    } catch (e) {
                        console.error('Failed to load logs:', e);
                    }
                },

                async pollLogs() {
                    try {
                        const response = await fetch('/logs?after=' + this.lastLogId);
                        const newLogs = await response.json();
                        if (newLogs && newLogs.length > 0) {
                            this.logs = [...newLogs.reverse(), ...this.logs];
                            if (this.logs.length > 100) {
                                this.logs = this.logs.slice(0, 100);
                            }
                            this.lastLogId = newLogs[newLogs.length - 1].id;
                            this.scrollLogsToBottom();
                        }
                    } catch (e) {
                        console.error('Failed to poll logs:', e);
                    }
                },

                scrollLogsToBottom() {
                    this.$nextTick(() => {
                        const container = document.getElementById('log-container');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },

                clearLogs() {
                    this.logs = [];
                    this.lastLogId = 0;
                },

                formatTime(timeStr) {
                    if (!timeStr || timeStr === '0001-01-01T00:00:00Z') {
                        return this.t('never');
                    }
                    try {
                        const date = new Date(timeStr);
                        return date.toLocaleString();
                    } catch (e) {
                        return timeStr;
                    }
                },

                formatLogTime(timeStr) {
                    try {
                        const date = new Date(timeStr);
                        return date.toLocaleTimeString();
                    } catch (e) {
                        return timeStr;
                    }
                }
            };
        }
    </script>
</body>
</html>
